<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Caterpillar</title>

    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
    <canvas width="256" height="256" id="capi" class="mx-auto m-16" data-raw-handle="1">
        Display for a game written in Caterpillar.
    </canvas>
    <script type="module">
        import init from "/capi.js";
        const wasm = await init("capi_bg.wasm");

        window.addEventListener("keydown", (event) => {
            let keyCode = null;

            if (event.key == "ArrowUp" || event.key == "w") {
                keyCode = 1;
            }
            if (event.key == "ArrowLeft" || event.key == "a") {
                keyCode = 2;
            }
            if (event.key == "ArrowDown" || event.key == "s") {
                keyCode = 3;
            }
            if (event.key == "ArrowRight" || event.key == "d") {
                keyCode = 4;
            }

            if (keyCode != null) {
                wasm.on_key(keyCode);
                event.preventDefault();
            }
        });

        window.requestAnimationFrame(mainLoop);

        function mainLoop() {
            while (true) {
                wasm.commands_read();
                const command_rx = new Uint8Array(
                    wasm.memory.buffer,
                    wasm.commands_read_ptr(),
                    wasm.commands_read_len(),
                );

                if (command_rx.byteLength > 0) {
                    wasm.commands_write(command_rx.byteLength);
                    const command_tx = new Uint8Array(
                        wasm.memory.buffer,
                        wasm.commands_write_ptr(),
                        wasm.commands_write_len(),
                    );
                    command_tx.set(command_rx);

                    wasm.on_command();
                }
                else {
                    break;
                }
            }

            wasm.on_frame();

            while (true) {
                wasm.updates_read();
                const update_rx = new Uint8Array(
                    wasm.memory.buffer,
                    wasm.updates_read_ptr(),
                    wasm.updates_read_len(),
                );

                if (update_rx.byteLength > 0) {
                    wasm.updates_write(update_rx.byteLength);
                    const update_tx = new Uint8Array(
                        wasm.memory.buffer,
                        wasm.updates_write_ptr(),
                        wasm.updates_write_len(),
                    );
                    update_tx.set(update_rx);

                    wasm.on_update();
                } else {
                    break;
                }
            }

            requestAnimationFrame(mainLoop);
        }
    </script>
    <script type="module">
        fetch("/updates").then((response) => {
            if (response.ok) {
                window.location.reload();
            }
            else {
                console.error("`/updates` returned error:");
                console.error(response);
            }
        });
    </script>
</body>

</html>